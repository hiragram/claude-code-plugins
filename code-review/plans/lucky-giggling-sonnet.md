# code-review Plugin 現状把握

## プロジェクト概要

PRを5つの観点から並列レビューするClaude Plugin。GitHub Actionsから呼び出される想定。

## 構造

```
code-review/
├── .claude-plugin/
│   └── plugin.json          # プラグイン定義
├── agents/                   # 5つの専門レビューエージェント
│   ├── code-quality-reviewer.md
│   ├── performance-reviewer.md
│   ├── test-coverage-reviewer.md
│   ├── documentation-accuracy-reviewer.md
│   └── security-code-reviewer.md
└── skills/
    └── review-pr/
        ├── SKILL.md          # メインスキル定義
        └── references/       # 各観点の詳細ドキュメント
            ├── code-quality.md
            ├── performance.md
            ├── test-coverage.md
            ├── documentation.md
            └── security.md
```

## 機能概要

### スキル: `/review-pr`

- **使い方**: `/review-pr [owner/repo] [pr-number]`
- **GitHub Actions環境**: 引数省略時は環境変数から自動取得

### 実行フロー

1. プロジェクトルール読み込み (CLAUDE.md)
2. PR情報取得 (`gh pr view`, `gh pr diff`)
3. 5つのサブエージェントを**並列起動**
4. 各エージェントが `mcp__github_inline_comment__create_inline_comment` でインラインコメントを投稿

### 5つのレビュー観点

| エージェント | 観点 | 色 |
|------------|------|-----|
| code-quality-reviewer | SRP, 命名規則, DRY, エラーハンドリング, 可読性 | blue |
| performance-reviewer | アルゴリズム複雑度, N+1, メモリリーク, キャッシュ | orange |
| test-coverage-reviewer | テスト有無, エッジケース, 独立性, モック, AAA | green |
| documentation-accuracy-reviewer | コード・コメント整合性, API文書, TODO | purple |
| security-code-reviewer | OWASP Top 10, 入力検証, 認証, 機密情報 | red |

### 各エージェント共通

- **tools**: Bash, Read, Grep, Glob
- **model**: sonnet
- インラインコメント形式が統一されている
- 「指摘しない項目」が明確に定義されている

## 現状の特徴

### 良い点
- 5観点の明確な分離
- 並列実行による効率化
- 詳細なリファレンスドキュメント
- 「指摘しない項目」の明示（過剰な指摘を防ぐ）
- 統一されたインラインコメント形式

### 改善検討ポイント

1. **MCP依存**: `mcp__github_inline_comment__create_inline_comment` はGitHub Actions環境で自動提供される前提だが、このMCPの詳細が不明

2. **言語・フレームワーク汎用性**: 例示がJavaScript/TypeScript中心。他言語へのガイダンスがない

3. **重複指摘の懸念**: 5エージェントが並列で動くため、同じ問題を複数エージェントが指摘する可能性

4. **プロジェクト固有ルールの反映**: CLAUDE.mdを読むとあるが、どう反映するかの詳細が薄い

5. **結果の集約**: 各エージェントが個別にコメント投稿するが、全体サマリーの生成・投稿方法が不明確

6. **エラー処理**: エージェント失敗時のフォールバックや再試行が定義されていない

---

## 改善要件

### 1. インラインコメントの位置修正

**問題**: diffの削除側にコメントを書いてしまうことがある

**要件**:
- 変更に関する指摘は基本的に**追加側（+行）**に書く
- 削除のみの変更（対応する追加行がない）の場合のみ削除側へのコメントを許可

**対応方針**:
- 各エージェントのプロンプトにインラインコメント位置のルールを追加
- diff解析時に「追加行」「削除行」「変更行（削除+追加のペア）」を区別するガイダンス

### 2. レビュー対応の自動追跡

**要件**:
- 同一PR内でpush後に自動的に前回コメントをチェック
- **すべてのレビューコメント**が対象（Claude + 人間のレビュー）
- 各コメントに対して「対応済み」「追加対応が必要」などのフォローアップを投稿

**対応方針**:
- `/review-pr` スキルの実行フローに「前回コメント確認」フェーズを追加
- GitHub APIで未解決のレビューコメントを取得
- 各コメントの指摘内容と現在のコード状態を比較
- フォローアップコメント（返信）を投稿

---

## 実装計画

### Phase 1: インラインコメント位置の修正

**変更ファイル**:
- `skills/review-pr/SKILL.md` - diff解析のガイダンス追加
- `agents/*.md` (全5ファイル) - コメント位置ルールの追加

**追加内容**:
```markdown
## インラインコメントの位置ルール

- **追加行（+）への指摘**: 追加された行にコメント
- **変更行（削除+追加のペア）**: 追加側の行にコメント
- **削除のみの行（-）**: 削除行にコメント（これのみ許可）

diff例:
```diff
- const old = "value";      ← 削除のみならここにコメント可
+ const new = "newValue";   ← 通常はここにコメント
```
```

### Phase 2: レビュー対応追跡機能

**変更ファイル**:
- `skills/review-pr/SKILL.md` - 追跡フローの追加

**新規追加フロー**:

```
┌─────────────────────────────────────────────────────────────┐
│ 1. 既存レビューコメントの取得                                │
│    gh api repos/{owner}/{repo}/pulls/{pr}/comments          │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│ 2. 未解決コメントのフィルタリング                            │
│    - in_reply_to_id が null のコメント（スレッドの親）       │
│    - 解決済みフラグがないもの                                │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│ 3. 各コメントの対応状況を確認                                │
│    - 指摘された行の現在のコードを確認                        │
│    - 指摘内容が修正されているか判定                          │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│ 4. フォローアップコメントを投稿                              │
│    - ✅ 対応済み: 修正が確認できた                           │
│    - ⚠️ 追加対応が必要: 一部修正or未対応                     │
│    - ℹ️ 確認不能: ファイル削除等で確認できない               │
└─────────────────────────────────────────────────────────────┘
```

**フォローアップコメント形式**:
```markdown
## ✅ 対応確認

この指摘は修正されています。

- **修正内容**: [具体的な修正の説明]

---
_🤖 Claude Code Review - follow-up check_
```

```markdown
## ⚠️ 追加対応が必要

この指摘はまだ完全には対応されていません。

- **現状**: [現在のコード状態]
- **残課題**: [まだ対応が必要な点]

---
_🤖 Claude Code Review - follow-up check_
```

---

## 検証方法

### Phase 1 の検証
- 既存のPRでdiffの削除行・追加行が混在するケースを用意
- `/review-pr` を実行し、コメントが追加行側に付くことを確認

### Phase 2 の検証
- テストPRで最初のレビューを実行
- 指摘された箇所を一部修正してpush
- 再度 `/review-pr` を実行
- 前回コメントへのフォローアップが返信として付くことを確認

---

## 変更対象ファイル一覧

| ファイル | 変更内容 |
|---------|---------|
| `skills/review-pr/SKILL.md` | コメント位置ルール追加、追跡フロー追加 |
| `agents/code-quality-reviewer.md` | コメント位置ルール追加 |
| `agents/performance-reviewer.md` | コメント位置ルール追加 |
| `agents/test-coverage-reviewer.md` | コメント位置ルール追加 |
| `agents/documentation-accuracy-reviewer.md` | コメント位置ルール追加 |
| `agents/security-code-reviewer.md` | コメント位置ルール追加 |
